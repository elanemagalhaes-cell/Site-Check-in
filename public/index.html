<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Check-in HUB</title>
  <style>
    body { font-family: Arial, sans-serif; background:#fff; display:flex; justify-content:center; align-items:center; height:100vh; margin:0; }
    .container { text-align:center; background:white; padding:30px; border-radius:20px; box-shadow:0 4px 20px rgba(0,0,0,0.1); width:320px; }
    h1 { color:#b24b1e; margin-bottom:20px; }
    input { width:90%; padding:10px; font-size:18px; border:1px solid #ccc; border-radius:10px; margin-bottom:20px; }
    button { width:95%; padding:12px; font-size:18px; border:none; border-radius:10px; background:#e18248; color:white; cursor:pointer; }
    button:disabled { opacity:0.6; cursor:not-allowed; }
    p { font-size:14px; color:#555; margin-top:10px; }
    img { width:120px; }
  </style>
</head>
<body>
  <div class="container">
    <img src="https://cf.shopee.com.br/file/sg-11134201-7rd4i-ly02kz5xgxyqa3" alt="Mascote Shopee" />
    <h1>üìç Check-in HUB</h1>
    <input id="driverId" placeholder="Informe seu ID" type="text" value="449213" />
    <!-- fallback onclick garante o disparo mesmo se o addEventListener n√£o anexar -->
    <button id="checkinBtn" onclick="window.__doCheckin && window.__doCheckin()">Registrar</button>
    <p id="statusMsg">Ative o GPS e permita a localiza√ß√£o.</p>
  </div>

  <script>
    console.log("‚úÖ script loaded");
    const btn = document.getElementById("checkinBtn");
    const input = document.getElementById("driverId");
    const statusMsg = document.getElementById("statusMsg");

    async function getPosition() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          return reject(new Error("Geolocation n√£o suportada"));
        }
        navigator.geolocation.getCurrentPosition(resolve, reject, {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 0
        });
      });
    }

    // fun√ß√£o global para o fallback onclick
    window.__doCheckin = async function () {
      try {
        console.log("üîπ Clique recebido");
        btn.disabled = true;
        statusMsg.style.color = "#555";
        statusMsg.textContent = "Obtendo localiza√ß√£o...";

        const id = (input.value || "").trim();
        if (!id) {
          statusMsg.textContent = "Informe seu ID antes de registrar.";
          btn.disabled = false;
          return;
        }

        // 1) ping (testa rota e CORS)
        try {
          const ping = await fetch("/api/ping").then(r => r.json());
          console.log("üì∂ /api/ping =>", ping);
        } catch (e) {
          console.warn("‚ö†Ô∏è Falha no /api/ping", e);
        }

        // 2) localiza√ß√£o
        const pos = await getPosition();
        const lat = Number(pos.coords.latitude.toFixed(6));
        const lng = Number(pos.coords.longitude.toFixed(6));
        const acc = Number(pos.coords.accuracy.toFixed(2));
        console.log("üìç Localiza√ß√£o:", { lat, lng, acc });

        statusMsg.textContent = "Localiza√ß√£o obtida, enviando...";

        // 3) POST /api/checkin
        const resp = await fetch("/api/checkin", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({
            id,
            lat,
            lng,
            acc,
            deviceId: "web-check",
            ua: navigator.userAgent
          })
        });

        const json = await resp.json().catch(() => ({}));
        console.log("üì° Resposta /api/checkin:", resp.status, json);

        if (!resp.ok) throw new Error(json.msg || "Falha no envio");

        statusMsg.textContent = "‚úÖ Check-in realizado com sucesso!";
        statusMsg.style.color = "green";
      } catch (err) {
        console.error("‚ùå Erro:", err);
        statusMsg.textContent = "Falha ao obter localiza√ß√£o ou enviar.";
        statusMsg.style.color = "red";
      } finally {
        btn.disabled = false;
      }
    };

    // listener ‚Äúnormal‚Äù (se falhar, o onclick do bot√£o garante)
    btn.addEventListener("click", (e) => {
      e.preventDefault();
      window.__doCheckin();
    });
  </script>
</body>
</html>
