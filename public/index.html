<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Check-in HUB</title>
  <style>
    :root { --brand:#d97a45; --bg:#fff7f2; }
    html,body{margin:0;padding:0;background:#fff;}
    .wrap{max-width:760px;margin:40px auto;padding:24px}
    .card{background:#fff;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:28px}
    h1{font-size:32px;margin:0 0 14px;color:#7b3b1b}
    .lead{color:#666;margin:-6px 0 18px}
    .row{margin:14px 0}
    input[type="text"]{width:100%;font-size:18px;padding:14px 16px;border-radius:12px;border:1px solid #e6e6e6;outline:none}
    button{width:100%;padding:16px;border:0;border-radius:12px;background:var(--brand);color:#fff;font-size:18px;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .msg{margin-top:14px;font-size:14px;color:#444}
    .msg.err{color:#b00020}
    .tag{display:inline-block;background:#ffe7d7;color:#7b3b1b;border-radius:999px;padding:4px 10px;font-size:12px;margin-right:6px}
    .logo{display:block;margin:0 auto 18px;max-width:200px}
    .muted{color:#777}
    .ok{color:#0a7b4f}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:680px){ .grid{grid-template-columns:1fr 1fr} }
    .small{font-size:12px;color:#777}
  </style>
</head>
<body>
  <div class="wrap">
    <img class="logo" src="./assets/shopee-dog.png" alt="Mascote" />
    <div class="card">
      <h1>üìç Check-in HUB</h1>
      <p class="lead">Informe seu <b>Driver ID</b> e permita a localiza√ß√£o.</p>

      <div class="row">
        <input id="idDriver" type="text" placeholder="Ex.: 449213" inputmode="numeric" />
      </div>

      <div class="row grid">
        <button id="btn" onclick="registrar()">Registrar</button>
        <button id="btnTryGps" onclick="testarGps()" type="button" title="Testa apenas o GPS">Testar GPS</button>
      </div>

      <div id="msg" class="msg muted"></div>
      <div id="dbg" class="small"></div>
    </div>

    <p class="small muted" style="margin-top:10px">
      Dica: se aparecer <i>‚Äúpermiss√£o negada‚Äù</i>, clique no cadeado üîí da URL ‚Üí Localiza√ß√£o ‚Üí <b>Permitir</b> e recarregue.
    </p>
  </div>

<script>
/* ========= util ========= */
const el = (id) => document.getElementById(id);
const sleep = (ms) => new Promise(r => setTimeout(r, ms));

function setMsg(text, kind='') {
  const m = el('msg');
  m.className = 'msg ' + (kind || '');
  m.textContent = text;
}

function setDbg(obj) {
  el('dbg').textContent = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);
}

/* pega/gera id do aparelho p/ regra de ‚Äúmesmo celular‚Äù */
function getDeviceId(){
  let d = localStorage.getItem('device_id');
  if (!d) {
    d = 'dev_' + crypto.getRandomValues(new Uint32Array(2)).join('');
    localStorage.setItem('device_id', d);
  }
  return d;
}

/* ========= geolocaliza√ß√£o ========= */
function pedirPosicao() {
  return new Promise((resolve, reject) => {
    if (!('geolocation' in navigator)) {
      return reject(new Error('Geolocaliza√ß√£o n√£o suportada neste navegador.'));
    }
    navigator.geolocation.getCurrentPosition(
      pos => resolve(pos),
      err => reject(err),
      { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
    );
  });
}

async function testarGps() {
  setMsg('Testando GPS‚Ä¶');
  try {
    const p = await pedirPosicao();
    const info = { lat: p.coords.latitude, lng: p.coords.longitude, acc: p.coords.accuracy + 'm' };
    setMsg('GPS OK ‚úì', 'ok');
    setDbg(info);
  } catch (e) {
    tratarErroGeo(e);
  }
}

function tratarErroGeo(e){
  // e.code: 1=PERMISSION_DENIED, 2=POSITION_UNAVAILABLE, 3=TIMEOUT
  const cod = e.code ?? '‚Äî';
  let msg = `Falha ao obter localiza√ß√£o (c√≥d ${cod}). `;
  if (cod === 1) msg += 'Permita a localiza√ß√£o no cadeado da URL e recarregue.';
  if (cod === 2) msg += 'Sinal fraco. V√° para √°rea aberta ou ative o GPS/Alta precis√£o.';
  if (cod === 3) msg += 'Tempo esgotado. Tente novamente.';
  setMsg(msg, 'err');
  setDbg(String(e?.message || e));
}

/* ========= envio ========= */
async function registrar() {
  const btn = el('btn');
  btn.disabled = true;
  setMsg('Coletando GPS‚Ä¶');

  const id = String(el('idDriver').value || '').trim().replace(/\D/g,'');
  if (!id) {
    setMsg('Informe o Driver ID.', 'err'); btn.disabled = false; return;
  }

  try {
    const pos = await pedirPosicao();
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    const acc = pos.coords.accuracy;

    setMsg('Enviando check-in‚Ä¶');

    const payload = {
      id,
      lat, lng, acc,
      deviceId: getDeviceId(),
      ua: navigator.userAgent
    };

    // Cloudflare Pages Functions: rota relativa
    const resp = await fetch('/api/checkin', {
      method: 'POST',
      headers: { 'content-type':'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await resp.json().catch(()=>({ ok:false, msg:'Erro ao ler resposta' }));

    if (resp.ok && data?.ok) {
      setMsg(`‚úÖ Check-in OK! ${data?.nome ? 'Driver: '+data.nome : ''}`);
      setDbg({enviado: payload, recebido: data});
    } else {
      // backend pode responder 200 com ok:false para FORA_RAIO etc.
      const texto = data?.msg || `Falha (${resp.status})`;
      setMsg(texto, 'err');
      setDbg({enviado: payload, recebido: data});
    }
  } catch (e) {
    tratarErroGeo(e);
  } finally {
    btn.disabled = false;
  }
}

/* ====== UX: preencher √∫ltimo ID digitado ====== */
(() => {
  const LAST_KEY = 'last_driver_id';
  const input = el('idDriver');
  input.value = localStorage.getItem(LAST_KEY) || '';
  input.addEventListener('change', () => localStorage.setItem(LAST_KEY, input.value));
})();
</script>
</body>
</html>
