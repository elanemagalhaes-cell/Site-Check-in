<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Check-in HUB</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#fff;margin:0}
    .wrap{max-width:520px;margin:48px auto;padding:24px 20px;border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.05);border:1px solid #eee}
    h1{font-size:28px;margin:0 0 16px;color:#a8582f}
    .row{margin:12px 0}
    input{width:100%;font-size:18px;padding:14px;border:1px solid #ddd;border-radius:10px}
    button{width:100%;padding:14px 16px;font-size:18px;border:0;border-radius:10px;background:#df864f;color:#fff;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    #msg{margin-top:12px;font-size:15px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üìç Check-in HUB</h1>

    <div class="row">
      <input id="id" inputmode="numeric" autocomplete="off" placeholder="Digite seu ID" />
    </div>

    <div class="row">
      <button id="btn" type="button">Registrar</button>
    </div>

    <div id="msg"></div>

    <details style="margin-top:10px">
      <summary>Debug</summary>
      <div id="dbg" style="font:12px/1.45 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;white-space:pre-wrap"></div>
    </details>
  </div>

  <script defer>
    // util de mensagem
    const msg = (text, ok=false) => {
      const el = document.getElementById('msg');
      el.textContent = text;
      el.style.color = ok ? '#1b873f' : '#b00020';
      console.log('CHK: MSG ‚Üí', text);
    };
    const dbg = (...a) => {
      console.log('CHK:', ...a);
      const d = document.getElementById('dbg');
      d.textContent += a.map(v => typeof v==='string'? v : JSON.stringify(v)).join(' ') + '\n';
    };

    // obter localiza√ß√£o (promisificado)
    function getPosition() {
      return new Promise((resolve, reject) => {
        if (!('geolocation' in navigator)) {
          reject(new Error('Geolocaliza√ß√£o n√£o suportada.'));
          return;
        }
        navigator.geolocation.getCurrentPosition(resolve, reject, {
          enableHighAccuracy: true, timeout: 15000, maximumAge: 0
        });
      });
    }

    // fluxo do bot√£o
    async function doCheckin() {
      const btn = document.getElementById('btn');
      const id  = document.getElementById('id').value.trim();

      if (!id) { msg('Informe o ID.', false); return; }

      btn.disabled = true; msg('Obtendo localiza√ß√£o‚Ä¶');
      try {
        // 1) Geolocaliza√ß√£o
        const pos = await getPosition();
        const lat = +pos.coords.latitude.toFixed(6);
        const lng = +pos.coords.longitude.toFixed(6);
        const acc = +pos.coords.accuracy.toFixed(2); // n√∫mero

        dbg('Local:', { lat, lng, acc });

        // 2) Ping de sanidade (opcional)
        try {
          const ping = await fetch('/api/ping').then(r=>r.json());
          dbg('Ping:', ping);
        } catch(_) { dbg('Ping falhou (ignorado)'); }

        msg('Enviando check-in‚Ä¶');

        // 3) POST /api/checkin (igual ao do console)
        const body = {
          id,
          lat,
          lng,
          acc,
          deviceId: localStorage.getItem('cid') || 'web',
          ua: navigator.userAgent
        };

        const resp = await fetch('/api/checkin', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify(body)
        });

        const json = await resp.json().catch(()=> ({}));
        dbg('Resposta /api/checkin:', resp.status, json);

        if (!resp.ok) {
          // MOSTRA motivo real (403 duplicado, fora do per√≠metro, etc.)
          msg(json?.msg || `Erro ${resp.status}`, false);
          return;
        }

        msg(json?.msg || 'Check-in registrado com sucesso!', true);
      } catch (e) {
        // erro de geolocaliza√ß√£o ou fetch
        msg(e?.message || 'Falha ao obter localiza√ß√£o ou enviar.', false);
      } finally {
        btn.disabled = false;
      }
    }

    // conectar handler quando DOM estiver pronto
    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('btn').addEventListener('click', doCheckin);
      dbg('DOM pronto. Handler conectado.');
    });
  </script>
</body>
</html>
