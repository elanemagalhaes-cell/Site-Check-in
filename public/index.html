<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Check-in HUB</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; }
    .wrap { min-height: 100dvh; display:grid; place-items:center; background:#fff5ef; }
    .card { width:min(92vw, 560px); background:#fff; border-radius:20px; padding:28px; box-shadow:0 12px 24px rgba(0,0,0,.08); }
    .title { font-size:clamp(22px,3.8vw,28px); font-weight:800; color:#a6532d; display:flex; gap:8px; align-items:center; margin-bottom:18px; }
    .pin { font-size:20px }
    .input, .btn { width:100%; border-radius:12px; border:none; font-size:18px; }
    .input { padding:14px 16px; background:#fafafa; outline:2px solid transparent; transition:.15s; }
    .input:focus { outline-color:#ffb088; background:#fff; }
    .btn { margin-top:14px; padding:16px; background:#df824f; color:#fff; font-weight:700; cursor:pointer; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .hint { margin-top:10px; color:#555; font-size:14px }
    .ok { color:#1c7c43 } .err { color:#b00020 }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  </style>
</head>
<body>
  <div class="wrap">
    <main class="card">
      <h1 class="title"><span class="pin">üìç</span>Check-in HUB</h1>

      <form id="form">
        <input id="id" class="input" inputmode="numeric" autocomplete="one-time-code"
               placeholder="Informe seu ID" required />
        <button id="btn" class="btn" type="submit">Registrar</button>
      </form>

      <p id="status" class="hint">Ative o GPS e permita a localiza√ß√£o.</p>
      <p id="log" class="hint" style="margin-top:4px"></p>
    </main>
  </div>

  <script>
    // -------- utilidades de UI / logs
    const $ = sel => document.querySelector(sel);
    const ui = {
      status: $('#status'),
      log:    $('#log'),
      btn:    $('#btn'),
      id:     $('#id'),
      set(t, cls='') { this.status.textContent = t; this.status.className = 'hint ' + cls; },
      msg(t)  { this.log.textContent = t; },
      busy(b) { this.btn.disabled = b; this.btn.textContent = b ? 'Enviando‚Ä¶' : 'Registrar'; }
    };
    const dlog = (...a) => { console.log('[CHK]', ...a); ui.msg(a.map(x => typeof x==='string'?x:JSON.stringify(x)).join(' ')); };

    // -------- geolocaliza√ß√£o em Promise
    function getPosition(opts = { enableHighAccuracy:true, timeout:15000, maximumAge:0 }) {
      return new Promise((resolve, reject) => {
        if (!('geolocation' in navigator)) return reject(new Error('Geolocaliza√ß√£o indispon√≠vel'));
        navigator.geolocation.getCurrentPosition(
          p => resolve({
            lat:  +p.coords.latitude.toFixed(6),
            lng:  +p.coords.longitude.toFixed(6),
            acc:  +p.coords.accuracy.toFixed(2)
          }),
          err => reject(err),
          opts
        );
      });
    }

    // -------- storage simples para um deviceId est√°vel
    function getDeviceId(){
      try {
        const k='chk_device_id';
        let v = localStorage.getItem(k);
        if (!v) { v = crypto.randomUUID?.() || Math.random().toString(36).slice(2); localStorage.setItem(k, v); }
        return v;
      } catch { return 'web-device'; }
    }

    // -------- envio do check-in
    async function doCheckin(id){
      ui.busy(true);
      dlog('Iniciando‚Ä¶ ID:', id);

      // 1) localiza√ß√£o
      ui.set('Obtendo localiza√ß√£o‚Ä¶');
      const pos = await getPosition();
      dlog('Local:', pos);

      // 2) ping (opcional, para ver roteamento das Functions)
      try {
        const pong = await fetch('/api/ping').then(r=>r.json());
        dlog('Ping:', pong);
      } catch(e){ dlog('Ping falhou:', e.message); }

      // 3) envio
      ui.set('Enviando check-in‚Ä¶');
      const body = {
        id: id.trim(),
        lat: pos.lat, lng: pos.lng, acc: pos.acc,
        deviceId: getDeviceId(),
        ua: navigator.userAgent
      };

      const resp = await fetch('/api/checkin', {
        method:'POST',
        headers:{'content-type':'application/json'},
        body: JSON.stringify(body)
      });

      let json = null;
      try { json = await resp.json(); } catch{}

      dlog('Resposta /api/checkin:', resp.status, json || '<sem json>');

      if (!resp.ok) {
        const msg = (json && json.msg) ? json.msg : `Falha (${resp.status})`;
        throw new Error(msg);
      }
      return json;
    }

    // -------- handler do formul√°rio
    $('#form').addEventListener('submit', async (ev) => {
      ev.preventDefault();                       // evita recarregar a p√°gina
      const id = ui.id.value.trim();
      if (!id) { ui.set('Informe o ID.', 'err'); return; }

      try {
        ui.set('Preparando‚Ä¶');
        // checa/mostra permiss√£o de geolocaliza√ß√£o (s√≥ loga; n√£o para o fluxo)
        try {
          const p = await navigator.permissions?.query?.({ name: 'geolocation' });
          if (p) dlog('Permiss√£o geolocation:', p.state);
        } catch {}

        const out = await doCheckin(id);

        ui.set(out.msg || 'Check-in registrado com sucesso!', 'ok');
        dlog('OK:', out);
      } catch (err) {
        console.error(err);
        ui.set('Falha ao obter localiza√ß√£o ou enviar.', 'err');
        ui.msg(err.message || String(err));
      } finally {
        ui.busy(false);
      }
    });

    // foco inicial para facilitar o teste
    ui.id.focus();
  </script>
</body>
</html>
